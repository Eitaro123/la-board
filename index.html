<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>ç ”ç©¶å®¤ åœ¨å¸­ç®¡ç†ãƒœãƒ¼ãƒ‰ (ç®¡ç†æ©Ÿèƒ½ä»˜)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #1e293b; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®ã‚«ãƒ©ãƒ¼å®šç¾© */
        .status-present-bg { background-color: #dcfce7; color: #166534; border-left-color: #22c55e; }
        .status-experiment-bg { background-color: #fef9c3; color: #854d0e; border-left-color: #eab308; }
        .status-class-bg { background-color: #dbeafe; color: #1e40af; border-left-color: #3b82f6; }
        .status-meeting-bg { background-color: #f3e8ff; color: #6b21a8; border-left-color: #a855f7; }
        .status-absent-bg { background-color: #f8fafc; color: #64748b; border-left-color: #94a3b8; }

        /* 3Dãƒ•ãƒªãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .flip-container { perspective: 1000px; height: 240px; cursor: default; }
        .flip-container.is-me { cursor: pointer; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.5s cubic-bezier(0.4, 0.0, 0.2, 1); transform-style: preserve-3d; }
        .flip-container.is-flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; top: 0; left: 0; border-radius: 0.75rem; overflow: hidden; }
        .flip-card-front { z-index: 2; transform: rotateY(0deg); border-left-width: 5px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease; }
        .flip-container.is-me .flip-card-front:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .flip-card-back { transform: rotateY(180deg); background-color: #ffffff; border: 2px solid #3b82f6; z-index: 1; display: flex; flex-direction: column; }
        
        .icon-scroll { cursor: grab; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .icon-scroll::-webkit-scrollbar { height: 2px; }
        
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); }
        .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; }
        .tab-inactive { border-bottom: 3px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #334155; border-bottom-color: #cbd5e1; }
    </style>
</head>
<body>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading-overlay" class="flex flex-col justify-center items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-slate-600 font-bold">ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸä¸­...</p>
    </div>

    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-sm">
                    <i class="fa-solid fa-graduation-cap text-lg"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight hidden md:block">è¿‘è—¤ç ”ç©¶å®¤ ãƒœãƒ¼ãƒ‰</h1>
                <h1 class="text-lg font-bold text-slate-800 tracking-tight md:hidden">è¿‘è—¤ç ”</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="window.promptRegisterDevice()" id="my-device-info" class="text-xs text-slate-500 hover:bg-slate-100 px-3 py-1.5 rounded-full border border-transparent hover:border-slate-200 flex items-center transition-colors">
                    <i class="fa-solid fa-mobile-screen-button mr-1.5"></i>
                    <span id="my-device-name" class="font-bold truncate max-w-[80px]">æœªè¨­å®š</span>
                </button>
                <div class="text-xl font-mono font-bold text-slate-700 w-14 text-right" id="current-clock">--:--</div>
            </div>
        </div>
        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="container mx-auto px-4 flex space-x-6">
            <button onclick="window.switchTab('board')" id="tab-board" class="tab-active py-3 px-1 transition-colors">
                <i class="fa-solid fa-chalkboard-user mr-1"></i> åœ¨å¸­ãƒœãƒ¼ãƒ‰
            </button>
            <button onclick="window.switchTab('admin')" id="tab-admin" class="tab-inactive py-3 px-1 transition-colors">
                <i class="fa-solid fa-users-gear mr-1"></i> ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 max-w-6xl">

        <!-- =======================
             VIEW 1: åœ¨å¸­ãƒœãƒ¼ãƒ‰
        ======================== -->
        <div id="view-board" class="animate-fade-in">
            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex bg-white p-1 rounded-lg shadow-sm border border-slate-200 w-full md:w-auto overflow-x-auto">
                    <button onclick="window.setFilter('all')" id="filter-all" class="filter-btn px-4 py-2 rounded-md text-sm font-bold text-white bg-blue-600 shadow transition-all whitespace-nowrap">å…¨å“¡</button>
                    <button onclick="window.setFilter('active')" id="filter-active" class="filter-btn px-4 py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-slate-100 transition-all whitespace-nowrap">åœ¨å®¤ãƒ»å­¦å†…ã®ã¿</button>
                    <button onclick="window.setFilter('absent')" id="filter-absent" class="filter-btn px-4 py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-slate-100 transition-all whitespace-nowrap">ä¸åœ¨ãƒ»å¸°å®…</button>
                </div>

                <div class="flex space-x-2 w-full md:w-auto">
                    <button onclick="window.toggleNfcPanel()" class="flex-1 md:flex-none flex items-center justify-center space-x-2 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2.5 rounded-lg font-bold shadow-sm transition-colors">
                        <i class="fa-solid fa-wifi rotate-90"></i>
                        <span class="hidden sm:inline">NFCã‚¿ã‚°ä½œæˆ</span>
                        <span class="sm:hidden">NFC</span>
                    </button>
                </div>
            </div>

            <!-- åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨ãƒœã‚¿ãƒ³ -->
            <div id="setup-area" class="hidden mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                <h3 class="text-lg font-bold text-yellow-800 mb-2"><i class="fa-solid fa-database mr-2"></i>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç©ºã§ã™</h3>
                <button id="btn-initialize-db" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded shadow">åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²</button>
            </div>

            <!-- NFCãƒ„ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
            <div id="nfc-panel" class="hidden mb-8 animate-fade-in">
                <div class="bg-indigo-50 rounded-xl shadow-lg border border-indigo-200 overflow-hidden">
                    <div class="bg-indigo-100 px-6 py-3 border-b border-indigo-200 flex justify-between items-center">
                        <h3 class="font-bold text-indigo-800"><i class="fa-solid fa-wifi rotate-90 mr-2"></i>NFCã‚¿ã‚° / QRã‚³ãƒ¼ãƒ‰ä½œæˆ</h3>
                        <button onclick="window.toggleNfcPanel()" class="text-indigo-400 hover:text-indigo-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-indigo-600 mb-1">ã‚¿ã‚°ã®ç¨®é¡</label>
                                    <div class="flex gap-2">
                                        <button onclick="window.setNfcMode('shared')" id="btn-mode-shared" class="flex-1 py-2 px-3 rounded border text-sm font-bold bg-indigo-600 text-white border-indigo-600">ğŸ¢ å ´æ‰€ç”¨ (å…±æœ‰)</button>
                                        <button onclick="window.setNfcMode('personal')" id="btn-mode-personal" class="flex-1 py-2 px-3 rounded border text-sm font-bold bg-white text-indigo-600 border-indigo-300">ğŸ‘¤ å€‹äººç”¨ (ç‰¹å®š)</button>
                                    </div>
                                </div>
                                <div id="nfc-target-wrapper" class="hidden">
                                    <label class="block text-xs font-bold text-indigo-600 mb-1">å¯¾è±¡è€… (å€‹äººç”¨ã®ã¿)</label>
                                    <select id="nfc-target-name" class="w-full border border-indigo-200 rounded p-2 text-sm bg-white"></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-indigo-600 mb-1">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
                                    <select id="nfc-preset-location" class="w-full border border-indigo-200 rounded p-2 text-sm bg-white">
                                        <option value="present:407">ğŸ¢ 407 ã«åˆ°ç€ (åœ¨å®¤)</option>
                                        <option value="present:æ•™æˆå®¤">ğŸ—£ï¸ æ•™æˆå®¤ ã«åˆ°ç€ (åœ¨å®¤)</option>
                                        <option value="absent:-">ğŸ  å¸°å®…ã™ã‚‹ (ä¸åœ¨)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="bg-indigo-900 bg-opacity-5 rounded-lg p-4 border border-indigo-100 flex flex-col justify-between">
                                <div>
                                    <label class="block text-xs font-bold text-indigo-800 mb-2">æ›¸ãè¾¼ã¿ç”¨URL</label>
                                    <div class="bg-white p-3 rounded border border-indigo-200 break-all font-mono text-xs text-slate-600 mb-3 select-all" id="generated-url">https://...</div>
                                </div>
                                <button onclick="window.simulateNfcScan()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded text-sm shadow-md transition-colors"><i class="fa-solid fa-play mr-2"></i> ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4 text-slate-600 text-sm font-medium flex items-center justify-between">
                <div>
                    <span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                    æ´»å‹•ä¸­: <span id="count-present" class="font-bold text-slate-900 text-lg mx-1">0</span> å
                </div>
            </div>

            <div id="members-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
        </div>

        <!-- =======================
             VIEW 2: ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†
        ======================== -->
        <div id="view-admin" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 sticky top-24">
                        <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                            <i class="fa-solid fa-user-plus text-blue-600 mr-2"></i> æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">æ°å</label>
                                <input type="text" id="admin-add-name" placeholder="ä¾‹: å±±ç”° å¤ªéƒ" class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">å½¹è· / å­¦å¹´</label>
                                <select id="admin-add-role" class="w-full border border-slate-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                    <option value="Bachelor">å­¦éƒ¨ç”Ÿ (B4)</option>
                                    <option value="Master">ä¿®å£« (M1/M2)</option>
                                    <option value="Doctor">åšå£« (D)</option>
                                    <option value="Assistant Professor">åŠ©æ•™</option>
                                    <option value="Professor">æ•™æˆ</option>
                                    <option value="Secretary">ç§˜æ›¸</option>
                                    <option value="Researcher">ç ”ç©¶å“¡</option>
                                </select>
                            </div>
                            <div class="pt-2">
                                <button onclick="window.addMember()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center justify-center">
                                    <i class="fa-solid fa-plus mr-2"></i> ç™»éŒ²ã™ã‚‹
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆ -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h2 class="font-bold text-slate-700">ç™»éŒ²æ¸ˆã¿ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</h2>
                            <span class="text-xs font-mono text-slate-400 bg-white px-2 py-1 rounded border" id="admin-total-count">0å</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-slate-600">
                                <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3 w-16 text-center">Icon</th>
                                        <th class="px-6 py-3">æ°å</th>
                                        <th class="px-6 py-3">å½¹è·</th>
                                        <th class="px-6 py-3 text-right">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-member-list" class="divide-y divide-slate-100">
                                    <!-- JSã§æŒ¿å…¥ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«é¡ -->
    <div id="device-register-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden">
            <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-mobile-screen-button mr-2"></i>ç«¯æœ«è¨­å®š</h3>
                <button onclick="window.closeRegisterModal()" class="text-blue-200 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-600 mb-4">ã“ã®ç«¯æœ«ã®æŒã¡ä¸»ã‚’è¨­å®šã—ã¾ã™ã€‚<br><span class="text-xs text-slate-400">â€»NFCã‚¿ã‚°èª­ã¿å–ã‚Šæ™‚ã«è‡ªå‹•ã§èªè­˜ã•ã‚Œã¾ã™ã€‚</span></p>
                <select id="modal-input-name" class="w-full border border-slate-300 rounded-lg p-2.5 mb-4 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                <button onclick="window.submitRegisterDevice()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg shadow hover:bg-blue-700 transition-colors mb-2">ç™»éŒ²ã™ã‚‹</button>
                <button onclick="window.clearRegisterDevice()" class="w-full bg-white text-red-500 border border-red-200 font-bold py-2 rounded-lg hover:bg-red-50 transition-colors text-sm">è¨­å®šã‚’è§£é™¤</button>
            </div>
        </div>
    </div>

    <div id="crop-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[110] flex flex-col justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-slate-800 px-4 py-3 flex justify-between items-center text-white">
                <h3 class="font-bold"><i class="fa-solid fa-crop-simple mr-2"></i>ç”»åƒã‚’åˆ‡ã‚ŠæŠœã</h3>
                <button onclick="window.closeCropModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex-1 bg-black relative overflow-hidden min-h-[300px]">
                <img id="crop-image" src="" alt="Crop" class="max-w-full block">
            </div>
            <div class="p-4 bg-white flex justify-end gap-3">
                <button onclick="window.closeCropModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="window.saveCroppedImage()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow">åˆ‡ã‚ŠæŠœã</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ</div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, updateDoc, writeBatch, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2orsNpZqkfn4qor8SfS-AKjfelfov11A",
            authDomain: "lala-54834.firebaseapp.com",
            projectId: "lala-54834",
            storageBucket: "lala-54834.firebasestorage.app",
            messagingSenderId: "578411123082",
            appId: "1:578411123082:web:ec6e0637a5865e1aa3f873"
        };

        let db;
        let membersData = [];
        const COL_NAME = "members";

        // åˆæœŸåŒ–
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            
            onSnapshot(collection(db, COL_NAME), (snapshot) => {
                const members = [];
                snapshot.forEach((doc) => members.push({ id: parseInt(doc.id), ...doc.data() }));

                if (members.length === 0) {
                    document.getElementById('setup-area').classList.remove('hidden');
                } else {
                    document.getElementById('setup-area').classList.add('hidden');
                    membersData = members;
                    renderAll(); 
                    if(!window.urlParamsChecked) {
                        checkUrlParameters();
                        window.urlParamsChecked = true;
                    }
                }
                document.getElementById('loading-overlay').style.display = 'none';
            }, (error) => {
                console.error("Firestore Error:", error);
                document.getElementById('loading-overlay').style.display = 'none';
            });
        } catch (e) { console.error(e); }

        const iconPresets = [
            "fa-user", "fa-user-graduate", "fa-user-tie", "fa-cat", "fa-dog", "fa-dragon",
            "fa-robot", "fa-ghost", "fa-mug-hot", "fa-bicycle", "fa-gamepad", "fa-futbol", "fa-book"
        ];
        const statusConfig = {
            present:    { label: "åœ¨å®¤", icon: "fa-laptop", cssClass: "status-present-bg", btnColor: "bg-green-100 text-green-700 hover:bg-green-200" },
            experiment: { label: "å®Ÿé¨“", icon: "fa-flask", cssClass: "status-experiment-bg", btnColor: "bg-yellow-100 text-yellow-700 hover:bg-yellow-200" },
            class:      { label: "æˆæ¥­", icon: "fa-book-open", cssClass: "status-class-bg", btnColor: "bg-blue-100 text-blue-700 hover:bg-blue-200" },
            meeting:    { label: "ä¼šè­°", icon: "fa-users", cssClass: "status-meeting-bg", btnColor: "bg-purple-100 text-purple-700 hover:bg-purple-200" },
            absent:     { label: "å¸°å®…", icon: "fa-house", cssClass: "status-absent-bg", btnColor: "bg-slate-100 text-slate-600 hover:bg-slate-200" }
        };

        let currentFilter = 'all';
        let nfcMode = 'shared';
        let activeCardId = null;
        let cropper;
        let currentEditMemberId = null;
        let currentTab = 'board';

        // --- Core Functions ---
        window.switchTab = (tabName) => {
            currentTab = tabName;
            document.getElementById('view-board').className = tabName === 'board' ? 'block animate-fade-in' : 'hidden';
            document.getElementById('view-admin').className = tabName === 'admin' ? 'block animate-fade-in' : 'hidden';
            
            document.getElementById('tab-board').className = tabName === 'board' ? 'tab-active py-3 px-1' : 'tab-inactive py-3 px-1';
            document.getElementById('tab-admin').className = tabName === 'admin' ? 'tab-active py-3 px-1' : 'tab-inactive py-3 px-1';
        };

        function renderAll() {
            renderBoard();
            renderAdminList();
        }

        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        }

        function showToast(message) {
            const x = document.getElementById("toast");
            x.textContent = message;
            x.className = "toast show";
            setTimeout(() => x.className = x.className.replace("show", ""), 3000);
        }

        // --- Board Rendering ---
        function renderBoard() {
            const grid = document.getElementById('members-grid');
            const nfcSelect = document.getElementById('nfc-target-name');
            const modalSelect = document.getElementById('modal-input-name');
            
            const myId = parseInt(localStorage.getItem('labApp_myId')) || null;
            let myName = "æœªè¨­å®š";

            grid.innerHTML = '';
            nfcSelect.innerHTML = ''; 
            modalSelect.innerHTML = '<option value="" disabled selected>åå‰ã‚’é¸æŠ...</option>';

            let activeCount = 0;
            const sorted = [...membersData].sort((a, b) => {
                if (a.id === myId) return -1;
                if (b.id === myId) return 1;
                const aAct = a.status !== 'absent', bAct = b.status !== 'absent';
                if (aAct !== bAct) return bAct - aAct;
                return a.id - b.id;
            });

            sorted.forEach(member => {
                const opt1 = document.createElement('option'); opt1.value = member.id; opt1.textContent = member.name; nfcSelect.appendChild(opt1);
                const opt2 = document.createElement('option'); opt2.value = member.id; opt2.textContent = member.name; modalSelect.appendChild(opt2);
                if (member.id === myId) myName = member.name;

                const isAbsent = member.status === 'absent';
                if (!((currentFilter === 'active' && isAbsent) || (currentFilter === 'absent' && !isAbsent))) {
                    if (!isAbsent) activeCount++;
                    const config = statusConfig[member.status] || statusConfig['absent'];
                    const isMe = member.id === myId;
                    const rawIcon = member.icon || "fa-user";
                    const isImage = rawIcon.startsWith("data:image");
                    const iconHtml = isImage ? `<img src="${rawIcon}" class="w-full h-full object-cover rounded-full">` : `<i class="fa-solid ${rawIcon}"></i>`;

                    const div = document.createElement('div');
                    div.className = `flip-container ${isMe ? 'is-me' : ''}`;
                    div.id = `card-${member.id}`;
                    div.onclick = () => { if(isMe) window.flipCard(member.id, true); else if(!myId) showToast("ç«¯æœ«è¨­å®šã‚’ã—ã¦ãã ã•ã„"); else showToast("ä»–äººã®æ“ä½œã¯ã§ãã¾ã›ã‚“"); };

                    const badge = isMe ? `<span class="absolute top-2 right-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold z-10">YOU</span>` : '';
                    
                    div.innerHTML = `
                        <div class="flip-card-inner">
                            <div class="flip-card-front ${config.cssClass} p-4">
                                <div class="relative h-full flex flex-col">
                                    ${badge}
                                    <div class="flex items-start space-x-3 mb-2">
                                        <div class="w-12 h-12 rounded-full flex-shrink-0 flex items-center justify-center bg-white bg-opacity-60 shadow-sm text-2xl text-slate-600 overflow-hidden">${iconHtml}</div>
                                        <div class="flex-1 min-w-0 pt-1">
                                            <span class="text-[10px] font-bold uppercase tracking-wider opacity-60 block leading-none mb-1">${member.role}</span>
                                            <h3 class="text-lg font-bold text-slate-800 leading-tight truncate">${member.name}</h3>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-1.5 mt-1">
                                        <div class="flex items-center justify-between bg-white bg-opacity-60 rounded px-3 py-1 shadow-sm"><span class="text-[10px] font-bold opacity-60">çŠ¶æ…‹</span><span class="text-sm font-bold">${config.label}</span></div>
                                        <div class="flex items-center justify-between bg-white bg-opacity-60 rounded px-3 py-1 shadow-sm"><span class="text-[10px] font-bold opacity-60">å ´æ‰€</span><span class="text-sm font-medium truncate max-w-[100px]">${member.location||'-'}</span></div>
                                    </div>
                                    <div class="mt-auto text-right"><span class="text-[10px] opacity-60 font-mono bg-white bg-opacity-40 px-1.5 py-0.5 rounded">${member.time}</span></div>
                                </div>
                            </div>
                            <div class="flip-card-back">
                                <div class="h-full flex flex-col p-3 relative">
                                    <div class="flex justify-between items-center mb-1"><h4 class="text-xs font-bold text-slate-400">æ“ä½œ</h4><button onclick="event.stopPropagation();window.flipCard(${member.id}, false)" class="text-slate-400"><i class="fa-solid fa-xmark"></i></button></div>
                                    <div class="grid grid-cols-3 gap-1 mb-2">
                                        ${Object.keys(statusConfig).map(k => `<button onclick="event.stopPropagation();window.selectStatus(${member.id},'${k}')" class="py-1 rounded ${statusConfig[k].btnColor} text-[10px] font-bold">${statusConfig[k].label}</button>`).join('')}
                                    </div>
                                    <div class="mb-2">
                                        <div class="flex justify-between items-center mb-1"><span class="text-[10px] font-bold text-slate-300">ICON</span><label class="cursor-pointer bg-slate-50 px-2 rounded text-[10px] text-slate-500 border border-slate-100" onclick="event.stopPropagation()"><i class="fa-solid fa-camera"></i><input type="file" class="hidden" accept="image/*" onchange="window.handleImageSelect(event, ${member.id})"></label></div>
                                        <div class="icon-scroll flex gap-1.5 overflow-x-auto pb-1" onclick="event.stopPropagation()">
                                            ${iconPresets.map(ic => `<button onclick="window.selectIcon(${member.id}, '${ic}', this)" class="flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-slate-400 hover:bg-slate-100 border ${rawIcon===ic ? 'border-blue-500 bg-blue-50 text-blue-600':'border-slate-100'}"><i class="fa-solid ${ic} text-xs"></i></button>`).join('')}
                                        </div>
                                    </div>
                                    <div class="mt-auto w-full flex items-center gap-2">
                                        <input type="text" id="loc-input-${member.id}" placeholder="å ´æ‰€ãƒ¡ãƒ¢" class="flex-1 border border-slate-200 rounded px-2 py-1.5 text-xs bg-slate-50" value="${member.location!=='-'?member.location:''}" onclick="event.stopPropagation()">
                                        <button onclick="event.stopPropagation();window.submitUpdate(${member.id})" class="bg-blue-600 text-white w-8 h-8 rounded flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(div);
                }
            });

            document.getElementById('count-present').textContent = activeCount;
            document.getElementById('admin-total-count').textContent = membersData.length + "å";

            const devName = document.getElementById('my-device-name');
            const devInfo = document.getElementById('my-device-info');
            if (myId) {
                devInfo.classList.remove('text-slate-500'); devInfo.classList.add('text-blue-600', 'bg-blue-50', 'border-blue-100');
                devName.textContent = myName.split(" ")[0];
            } else {
                devInfo.classList.add('text-slate-500'); devInfo.classList.remove('text-blue-600', 'bg-blue-50', 'border-blue-100');
                devName.textContent = "æœªè¨­å®š";
            }
        }

        // --- Admin Rendering & Logic ---
        function renderAdminList() {
            const list = document.getElementById('admin-member-list');
            list.innerHTML = '';
            
            // IDé †ã«ã‚½ãƒ¼ãƒˆ
            const sorted = [...membersData].sort((a,b) => a.id - b.id);
            
            sorted.forEach(m => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                
                const rawIcon = m.icon || "fa-user";
                const isImage = rawIcon.startsWith("data:image");
                const iconDisplay = isImage 
                    ? `<img src="${rawIcon}" class="w-8 h-8 rounded-full object-cover border border-slate-200">` 
                    : `<div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400"><i class="fa-solid ${rawIcon}"></i></div>`;

                tr.innerHTML = `
                    <td class="px-6 py-4">${iconDisplay}</td>
                    <td class="px-6 py-4 font-bold text-slate-700">${m.name}</td>
                    <td class="px-6 py-4 text-xs font-mono text-slate-500 bg-slate-50 rounded px-2 py-1 w-fit">${m.role}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="window.deleteMember(${m.id}, '${m.name}')" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition-colors" title="å‰Šé™¤">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                list.appendChild(tr);
            });
        }

        window.addMember = async () => {
            if (!db) return;
            const nameInput = document.getElementById('admin-add-name');
            const roleInput = document.getElementById('admin-add-role');
            const name = nameInput.value.trim();
            const role = roleInput.value;

            if (!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            // æ–°ã—ã„IDã‚’ç”Ÿæˆ (ç¾åœ¨ã®æœ€å¤§ID + 1)
            const maxId = membersData.length > 0 ? Math.max(...membersData.map(m => m.id)) : 0;
            const newId = maxId + 1;

            try {
                await setDoc(doc(db, COL_NAME, newId.toString()), {
                    id: newId,
                    name: name,
                    role: role,
                    status: 'absent',
                    location: '-',
                    time: getCurrentTime(),
                    icon: 'fa-user',
                    updatedAt: serverTimestamp()
                });
                nameInput.value = '';
                showToast(`${name}ã•ã‚“ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
            } catch(e) {
                alert("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        };

        window.deleteMember = async (id, name) => {
            if (!db) return;
            if (!confirm(`${name}ã•ã‚“ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

            try {
                await deleteDoc(doc(db, COL_NAME, id.toString()));
                
                // è‡ªåˆ†ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã‚‚æ¶ˆã™
                const myId = parseInt(localStorage.getItem('labApp_myId'));
                if (myId === id) {
                    localStorage.removeItem('labApp_myId');
                    showToast("è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ");
                } else {
                    showToast("å‰Šé™¤ã—ã¾ã—ãŸ");
                }
            } catch(e) {
                alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        };

        // --- Interaction Logic (Same as before) ---
        window.updateMemberFirestore = async (id, status, location, icon = null) => {
            if (!db) return false;
            try {
                const data = { status, location, time: getCurrentTime(), updatedAt: serverTimestamp() };
                if(icon) data.icon = icon;
                await updateDoc(doc(db, COL_NAME, id.toString()), data);
                showToast(`æ›´æ–°ã—ã¾ã—ãŸ`);
                return true;
            } catch (e) { alert("æ›´æ–°å¤±æ•—: " + e.message); return false; }
        }

        window.flipCard = (id, isFlipped) => {
            if (isFlipped && activeCardId && activeCardId !== id) document.getElementById(`card-${activeCardId}`)?.classList.remove('is-flipped');
            const card = document.getElementById(`card-${id}`);
            if (card) {
                isFlipped ? card.classList.add('is-flipped') : card.classList.remove('is-flipped');
                activeCardId = isFlipped ? id : null;
            }
        };

        window.selectStatus = (id, statusKey) => {
            let loc = document.getElementById(`loc-input-${id}`).value;
            if (statusKey === 'absent') loc = "-";
            else if (!loc || ['-','ç ”ç©¶å®¤','å®Ÿé¨“å®¤','è¬›ç¾©æ£Ÿ','å­¦å†…'].includes(loc)) {
                const map = {present:'ç ”ç©¶å®¤', experiment:'å®Ÿé¨“å®¤', class:'è¬›ç¾©æ£Ÿ', meeting:'å­¦å†…', break:'å­¦å†…'};
                loc = map[statusKey] || 'å­¦å†…';
            }
            document.getElementById(`loc-input-${id}`).value = loc;
            window.updateMemberFirestore(id, statusKey, loc).then(res => res && window.flipCard(id, false));
        };

        window.selectIcon = (id, icon, btn) => {
            btn.parentNode.querySelectorAll('button').forEach(b => b.className = "flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-slate-400 hover:bg-slate-100 border border-slate-100");
            btn.className = "flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-blue-600 bg-blue-50 border border-blue-500";
            document.getElementById(`loc-input-${id}`).dataset.selectedIcon = icon;
        };

        window.submitUpdate = (id) => {
            const member = membersData.find(m => m.id === id);
            const loc = document.getElementById(`loc-input-${id}`).value;
            const icon = document.getElementById(`loc-input-${id}`).dataset.selectedIcon || member.icon;
            window.updateMemberFirestore(id, member.status, loc, icon).then(res => res && window.flipCard(id, false));
        };

        // --- Image Crop ---
        window.handleImageSelect = (e, id) => {
            const file = e.target.files[0];
            if (!file) return;
            currentEditMemberId = id;
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('crop-image').src = ev.target.result;
                document.getElementById('crop-modal').classList.remove('hidden');
                if(cropper) cropper.destroy();
                cropper = new Cropper(document.getElementById('crop-image'), { aspectRatio: 1, viewMode: 1, autoCropArea: 1 });
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        };
        window.saveCroppedImage = () => {
            if(!cropper || !currentEditMemberId) return;
            const canvas = cropper.getCroppedCanvas({ width: 128, height: 128 });
            const base64 = canvas.toDataURL('image/jpeg', 0.8);
            const input = document.getElementById(`loc-input-${currentEditMemberId}`);
            if(input) input.dataset.selectedIcon = base64;
            window.closeCropModal();
            showToast("ç”»åƒã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ(æ›´æ–°ãƒœã‚¿ãƒ³ã§ä¿å­˜)");
        };
        window.closeCropModal = () => { document.getElementById('crop-modal').classList.add('hidden'); if(cropper) cropper.destroy(); };

        // --- Setup / Device Reg ---
        window.promptRegisterDevice = () => {
            const modal = document.getElementById('device-register-modal');
            const myId = localStorage.getItem('labApp_myId');
            if(myId) document.getElementById('modal-input-name').value = myId;
            modal.classList.remove('hidden');
        };
        window.closeRegisterModal = () => document.getElementById('device-register-modal').classList.add('hidden');
        window.submitRegisterDevice = () => {
            const id = document.getElementById('modal-input-name').value;
            if(!id) return alert("åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„");
            localStorage.setItem('labApp_myId', id);
            window.closeRegisterModal();
            renderBoard();
        };
        window.clearRegisterDevice = () => {
            if(confirm("è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('labApp_myId'); window.closeRegisterModal(); renderBoard(); }
        };
        document.getElementById('btn-initialize-db').addEventListener('click', async () => {
             if(!confirm("åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;
             const batch = writeBatch(db);
             const defaults = [
                 { id: 1, name: "è¿‘è—¤ æ•™æˆ", role: "Professor" }, { id: 2, name: "å®®ä¸‹ åŠ©æ•™", role: "Assistant Professor" },
                 { id: 3, name: "ä½è—¤ (M2)", role: "Master" }, { id: 4, name: "æ¦æœ¬ (B4)", role: "Bachelor" }
             ];
             defaults.forEach(m => batch.set(doc(db, COL_NAME, m.id.toString()), { ...m, status: 'absent', location: '-', icon: 'fa-user', time: getCurrentTime() }));
             await batch.commit();
        });

        // --- NFC / Others ---
        window.setFilter = (f) => {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => { b.classList.remove('bg-blue-600','text-white','shadow'); b.classList.add('text-slate-500','hover:bg-slate-100'); });
            const target = document.getElementById('filter-'+f);
            target.classList.remove('text-slate-500','hover:bg-slate-100'); target.classList.add('bg-blue-600','text-white','shadow');
            renderBoard();
        };
        window.toggleNfcPanel = () => { document.getElementById('nfc-panel').classList.toggle('hidden'); window.updateNfcUrl(); };
        window.setNfcMode = (m) => {
            nfcMode = m;
            document.getElementById('nfc-target-wrapper').classList.toggle('hidden', m === 'shared');
            document.getElementById('btn-mode-shared').className = m==='shared'?"flex-1 py-2 px-3 rounded border text-sm font-bold bg-indigo-600 text-white border-indigo-600":"flex-1 py-2 px-3 rounded border text-sm font-bold bg-white text-indigo-600 border-indigo-300";
            document.getElementById('btn-mode-personal').className = m==='personal'?"flex-1 py-2 px-3 rounded border text-sm font-bold bg-indigo-600 text-white border-indigo-600":"flex-1 py-2 px-3 rounded border text-sm font-bold bg-white text-indigo-600 border-indigo-300";
            window.updateNfcUrl();
        };
        window.updateNfcUrl = () => {
            const id = document.getElementById('nfc-target-name').value;
            const [st, lc] = (document.getElementById('nfc-preset-location').value||":").split(':');
            let url = `${location.protocol}//${location.host}${location.pathname}?status=${st}&loc=${encodeURIComponent(lc||"")}`;
            if(nfcMode==='personal' && id) url += `&nfc_id=${id}`;
            document.getElementById('generated-url').textContent = url;
        };
        document.getElementById('nfc-target-name').onchange = window.updateNfcUrl;
        document.getElementById('nfc-preset-location').onchange = window.updateNfcUrl;
        window.simulateNfcScan = () => { try { checkUrlParameters(new URLSearchParams(new URL(document.getElementById('generated-url').textContent).search)); } catch(e){} };

        async function checkUrlParameters(params = null) {
            const p = params || new URLSearchParams(location.search);
            if (!p.has('status')) return;
            const st = p.get('status'), lc = p.get('loc');
            let tid = p.has('nfc_id') ? parseInt(p.get('nfc_id')) : parseInt(localStorage.getItem('labApp_myId'));
            if (tid) {
                await updateMemberFirestore(tid, st, lc);
                if (!params) history.replaceState(null, '', location.pathname);
            } else if (!params) alert("ã€å…±æœ‰ã‚¿ã‚°æ¤œçŸ¥ã€‘\nç«¯æœ«è¨­å®šãŒã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        }

        setInterval(() => document.getElementById('current-clock').textContent = getCurrentTime(), 1000);
        document.getElementById('current-clock').textContent = getCurrentTime();
    </script>
</body>
</html>